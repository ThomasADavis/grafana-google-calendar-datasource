{"version":3,"sources":["../src/datasource.js"],"names":["_","moment","gpai","GoogleCalendarDatasource","instanceSettings","$q","templateSrv","type","name","clientId","jsonData","scopes","q","options","annotation","calendarId","deferred","defer","isEmpty","resolve","self","gapi","load","auth2","init","client_id","scope","then","client","calendar","events","list","range","from","toISOString","to","response","result","items","chain","map","event","start","dateTime","date","end","time","valueOf","title","summary","tags","text","flatten","value","error","reject","promise"],"mappings":";;;;;;;;;;;;;;;AAAOA,O;;AACAC,Y;;AACAC,U;;;;;;;;;;;;;;;;;;;;;0CAEMC,wB;AAEX,0CAAYC,gBAAZ,EAA8BC,EAA9B,EAAkCC,WAAlC,EAA+C;AAAA;;AAC7C,eAAKC,IAAL,GAAYH,iBAAiBG,IAA7B;AACA,eAAKC,IAAL,GAAYJ,iBAAiBI,IAA7B;AACA,eAAKC,QAAL,GAAgBL,iBAAiBM,QAAjB,CAA0BD,QAA1C;AACA,eAAKE,MAAL,GAAc,mDAAd;AACA,eAAKC,CAAL,GAASP,EAAT;AACA,eAAKC,WAAL,GAAmBA,WAAnB;AACD;;;;2CAEgB;AACf,mBAAO,IAAP;AACD;;;0CAEeO,O,EAAS;AACvB,gBAAIC,aAAaD,QAAQC,UAAzB;AACA,gBAAIC,aAAaD,WAAWC,UAA5B;AACA,gBAAIC,WAAW,KAAKJ,CAAL,CAAOK,KAAP,EAAf;;AAEA,gBAAIjB,EAAEkB,OAAF,CAAUH,UAAV,CAAJ,EAA2B;AACzB,qBAAOC,SAASG,OAAT,CAAiB,EAAjB,CAAP;AACD;;AAED,gBAAIC,OAAO,IAAX;AACAC,iBAAKC,IAAL,CAAU,cAAV,EAA0B,YAAW;AACnC,kBAAIC,QAAQF,KAAKE,KAAL,CAAWC,IAAX,CAAgB,EAACC,WAAWL,KAAKX,QAAjB,EAA2BiB,OAAON,KAAKT,MAAvC,EAAhB,CAAZ;AACAY,oBAAMI,IAAN,CAAW,YAAY;AACrBN,qBAAKO,MAAL,CAAYN,IAAZ,CAAiB,UAAjB,EAA6B,IAA7B,EAAmC,YAAW;AAC5CD,uBAAKO,MAAL,CAAYC,QAAZ,CAAqBC,MAArB,CAA4BC,IAA5B,CAAiC;AAC/B,kCAAchB,UADiB;AAE/B,+BAAWF,QAAQmB,KAAR,CAAcC,IAAd,CAAmBC,WAAnB,EAFoB;AAG/B,+BAAWrB,QAAQmB,KAAR,CAAcG,EAAd,CAAiBD,WAAjB,EAHoB;AAI/B,mCAAe,KAJgB;AAK/B,oCAAgB,IALe;AAM/B,kCAAc,GANiB;AAO/B,+BAAW;AAPoB,mBAAjC,EAQGP,IARH,CAQQ,UAAUS,QAAV,EAAoB;AAC1B,wBAAIN,SAASM,SAASC,MAAT,CAAgBC,KAA7B;;AAEA,wBAAID,SAASrC,EAAEuC,KAAF,CAAQT,MAAR,EACVU,GADU,CACN,UAAUC,KAAV,EAAiB;AACpB,0BAAIC,QAAQzC,OAAOwC,MAAMC,KAAN,CAAYC,QAAZ,IAAwBF,MAAMC,KAAN,CAAYE,IAA3C,CAAZ;AACA,0BAAIC,MAAM5C,OAAOwC,MAAMI,GAAN,CAAUF,QAAV,IAAsBF,MAAMI,GAAN,CAAUD,IAAvC,CAAV;;AAEA,6BAAO,CACL;AACE9B,oCAAYA,UADd;AAEEgC,8BAAMJ,MAAMK,OAAN,EAFR;AAGEC,+BAAOP,MAAMQ,OAHf;AAIEC,8BAAM,CAAC,OAAD,CAJR;AAKEC,8BAAMV,MAAMQ;AALd,uBADK,EAQL;AACEnC,oCAAYA,UADd;AAEEgC,8BAAMD,IAAIE,OAAJ,EAFR;AAGEC,+BAAOP,MAAMQ,OAHf;AAIEC,8BAAM,CAAC,KAAD,CAJR;AAKEC,8BAAMV,MAAMQ;AALd,uBARK,CAAP;AAgBD,qBArBU,EAqBRG,OArBQ,GAqBEC,KArBF,EAAb;;AAuBArC,6BAASG,OAAT,CAAiBkB,MAAjB;AACD,mBAnCD;AAoCD,iBArCD;AAsCD,eAvCD,EAuCG,UAASiB,KAAT,EAAgB;AACjBtC,yBAASuC,MAAT,CAAgBD,KAAhB;AACD,eAzCD;AA0CD,aA5CD;;AA8CA,mBAAOtC,SAASwC,OAAhB;AACD","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\nimport gpai from './libs/api';\n\nexport class GoogleCalendarDatasource {\n\n  constructor(instanceSettings, $q, templateSrv) {\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.clientId = instanceSettings.jsonData.clientId;\n    this.scopes = 'https://www.googleapis.com/auth/calendar.readonly';\n    this.q = $q;\n    this.templateSrv = templateSrv;\n  }\n\n  testDatasource() {\n    return true;\n  }\n\n  annotationQuery(options) {\n    var annotation = options.annotation;\n    var calendarId = annotation.calendarId;\n    var deferred = this.q.defer();\n\n    if (_.isEmpty(calendarId)) {\n      return deferred.resolve([]);\n    }\n\n    var self = this;\n    gapi.load('client:auth2', function() {\n      var auth2 = gapi.auth2.init({client_id: self.clientId, scope: self.scopes});\n      auth2.then(function () {\n        gapi.client.load('calendar', 'v3', function() {\n          gapi.client.calendar.events.list({\n            'calendarId': calendarId,\n            'timeMin': options.range.from.toISOString(),\n            'timeMax': options.range.to.toISOString(),\n            'showDeleted': false,\n            'singleEvents': true,\n            'maxResults': 250,\n            'orderBy': 'startTime'\n          }).then(function (response) {\n            var events = response.result.items;\n\n            var result = _.chain(events)\n              .map(function (event) {\n                var start = moment(event.start.dateTime || event.start.date);\n                var end = moment(event.end.dateTime || event.end.date);\n\n                return [\n                  {\n                    annotation: annotation,\n                    time: start.valueOf(),\n                    title: event.summary,\n                    tags: ['start'],\n                    text: event.summary\n                  },\n                  {\n                    annotation: annotation,\n                    time: end.valueOf(),\n                    title: event.summary,\n                    tags: ['end'],\n                    text: event.summary\n                  }\n                ];\n              }).flatten().value();\n\n            deferred.resolve(result);\n          });\n        });\n      }, function(error) {\n        deferred.reject(error);\n      });\n    });\n\n    return deferred.promise;\n  }\n}\n"]}