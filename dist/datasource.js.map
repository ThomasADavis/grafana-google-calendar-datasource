{"version":3,"sources":["../src/datasource.js"],"names":["_","moment","gpai","GoogleCalendarDatasource","instanceSettings","$q","templateSrv","type","name","clientId","jsonData","scopes","discoveryDocs","q","initialized","onSuccess","onFail","self","gapi","load","client","init","scope","then","isSignedIn","auth2","getAuthInstance","get","listen","success","signIn","options","annotation","calendarId","deferred","defer","isEmpty","resolve","initialize","calendar","events","list","range","from","toISOString","to","response","result","items","chain","map","event","start","dateTime","date","end","time","valueOf","title","summary","tags","text","flatten","value","err","console","log","reject","promise"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\nimport gpai from './libs/api';\n\nexport class GoogleCalendarDatasource {\n\n  constructor(instanceSettings, $q, templateSrv) {\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.clientId = instanceSettings.jsonData.clientId;\n    this.scopes = 'https://www.googleapis.com/auth/calendar.readonly';\n    this.discoveryDocs = [\"https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest\"];\n    this.q = $q;\n    this.templateSrv = templateSrv;\n    this.initialized = false;\n  }\n\n  testDatasource() {\n    return true;\n  }\n\n  initialize(onSuccess, onFail) {\n    var self = this;\n    if (self.initialized) {\n      return onSuccess();\n    }\n\n    gapi.load('client:auth2', function () {\n      gapi.client.init({\n        clientId: self.clientId,\n        scope: self.scopes,\n        discoveryDocs: self.discoveryDocs\n      }).then(function () {\n        var isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();\n        if (!isSignedIn) {\n          gapi.auth2.getAuthInstance().isSignedIn.listen(function (success) {\n            if (success) {\n              self.initialized = true;\n              return onSuccess();\n            } else {\n              return onFail('failed to sign-in');\n            }\n          });\n          gapi.auth2.getAuthInstance().signIn();\n        } else {\n          self.initialized = true;\n          return onSuccess();\n        }\n      });\n    });\n  }\n\n  annotationQuery(options) {\n    var annotation = options.annotation;\n    var calendarId = annotation.calendarId;\n    var deferred = this.q.defer();\n\n    if (_.isEmpty(calendarId)) {\n      return deferred.resolve([]);\n    }\n\n    var self = this;\n    self.initialize(function () {\n      gapi.client.calendar.events.list({\n        'calendarId': calendarId,\n        'timeMin': options.range.from.toISOString(),\n        'timeMax': options.range.to.toISOString(),\n        'showDeleted': false,\n        'singleEvents': true,\n        'maxResults': 250,\n        'orderBy': 'startTime'\n      }).then(function (response) {\n        var events = response.result.items;\n\n        var result = _.chain(events)\n          .map(function (event) {\n            var start = moment(event.start.dateTime || event.start.date);\n            var end = moment(event.end.dateTime || event.end.date);\n\n            return [\n              {\n                annotation: annotation,\n                time: start.valueOf(),\n                title: event.summary,\n                tags: ['start'],\n                text: event.summary\n              },\n              {\n                annotation: annotation,\n                time: end.valueOf(),\n                title: event.summary,\n                tags: ['end'],\n                text: event.summary\n              }\n            ];\n          }).flatten().value();\n\n        deferred.resolve(result);\n      });\n    }, function (err) {\n      console.log(err);\n      deferred.reject(err);\n    });\n\n    return deferred.promise;\n  }\n}\n"]}